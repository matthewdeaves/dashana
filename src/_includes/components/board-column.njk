{% set columnTasks = tasks.sections[sectionName] %}
{% set doneTasks = columnTasks | selectattr("isDone") | list %}
{% set doneCount = doneTasks | length %}
{% set outstandingCount = columnTasks.length - doneCount %}

<div class="board-column {% if outstandingCount == 0 and columnTasks.length > 0 %}all-done{% endif %}">
  <div class="column-header">
    <div class="column-title-row">
      <h3 class="column-title">{{ sectionName }}</h3>
      <span class="column-count">{{ columnTasks.length }}</span>
    </div>
    {% if columnTasks.length > 0 %}
      <span class="column-progress {% if outstandingCount == 0 %}complete{% elif outstandingCount > 0 %}has-outstanding{% endif %}">
        {{ doneCount }}/{{ columnTasks.length }} complete
      </span>
    {% endif %}
  </div>
  <div class="column-cards">
    {% for task in columnTasks %}
      {% if task.parentInSameSection %}
        {# Skip - this subtask will be rendered under its parent #}
      {% elif task.hasSubtasksInSection %}
        {# This is a parent with subtasks - render as group #}
        <div class="task-group">
          {% include "components/task-card.njk" %}
          {% if task.subtasksElsewhereCount > 0 %}
          <div class="subtasks-elsewhere-indicator">
            {{ task.totalSubtaskCount }} subtasks total ({{ task.subtasksElsewhereCount }} in other columns)
          </div>
          {% endif %}
          <div class="subtasks-container">
            {% for t in task.subtasksInSection %}
              <div class="task-card {% if t.isDone %}is-done{% endif %} {% if t.isOverdue %}is-overdue{% endif %} is-subtask">
                <div class="card-header">
                  <span class="task-name">{{ t.name }}</span>
                  {% if config.cardItems.progress %}
                    {% if t.isDone %}
                      <span class="completion-label completion-done">Done</span>
                    {% else %}
                      <span class="completion-label completion-open">Open</span>
                    {% endif %}
                  {% endif %}
                </div>
                {% if config.cardItems.assignee and t.assignee and t.assignee != 'Unassigned' %}
                <div class="card-meta">
                  <span class="task-assignee">{{ t.assignee }}</span>
                </div>
                {% endif %}
                {% if config.cardItems.notes and t.notes %}
                  <span class="card-notes-icon" data-notes="{{ t.notes }}" tabindex="0" role="button" aria-label="View notes">üìù</span>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      {% else %}
        {# Regular task, parent with all subtasks elsewhere, or subtask whose parent is elsewhere #}
        <div class="{% if task.totalSubtaskCount > 0 and not task.isSubtask %}task-group{% endif %}">
          {% include "components/task-card.njk" %}
          {% if task.totalSubtaskCount > 0 and not task.isSubtask %}
          <div class="subtasks-elsewhere-indicator">
            {{ task.totalSubtaskCount }} subtask{% if task.totalSubtaskCount != 1 %}s{% endif %} in other columns
          </div>
          {% endif %}
        </div>
      {% endif %}
    {% endfor %}
  </div>
</div>
